generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Company {
  id       Int     @id @default(autoincrement())
  name     String
  cnpj     String?
  isActive Boolean @default(true)
  type     String  @default("MATRIZ") // MATRIZ, FILIAL

  groupId String?
  group   Group?  @relation(fields: [groupId], references: [id])

  members UserMembership[]

  // Manager Definition
  managerId Int?
  manager   User? @relation("CompanyManager", fields: [managerId], references: [id])

  // Roles available/scoped to this company
  roles Role[]

  // Dom√≠nio Web Integration
  dominioRubric String?
  dominioCode   String?

  // SaaS Fields
  planId                Int?
  plan                  Plan?     @relation(fields: [planId], references: [id])
  status                String    @default("active") // active, overdue, suspended
  subscriptionExpiresAt DateTime?

  users     User[]     @relation("LegacyCompanyUsers")
  employees Employee[]
  meals     Meal[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user   User? @relation(fields: [userId], references: [id])
  userId Int?
}

model Plan {
  id       Int     @id @default(autoincrement())
  name     String  @unique // Free, Starter, Pro
  maxUsers Int
  features String // JSON string: ["reports", "api", "priority_support"]
  price    Decimal @default(0.0)

  companies Company[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Invitation {
  id        String @id @default(uuid())
  email     String
  token     String @unique
  roleId    Int
  companyId Int

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

model AuditLog {
  id        String  @id @default(uuid())
  actorId   Int? // User who performed action
  action    String // CREATE, UPDATE, DELETE
  entity    String // User, Permisson, Company
  entityId  String // ID of affected entity
  details   String? // JSON with before/after data
  ipAddress String?

  createdAt DateTime @default(now())
}

model Group {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  companies Company[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model UserMembership {
  id     String @id @default(uuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id])

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
}

// RBAC Models
model Feature {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String?
  isActive    Boolean @default(true)

  permissions Permission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String?

  featureId Int
  feature   Feature @relation(fields: [featureId], references: [id])

  roles Role[]
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  permissions Permission[]
  users       User[]
  members     UserMembership[]

  // Scoping: This role is valid for these companies
  companies Company[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  password    String
  name        String
  phone       String?
  jobTitle    String?
  bio         String?
  address     String?
  preferences String?
  isActive    Boolean @default(true)

  memberships UserMembership[]

  // Deprecated (Legacy) - Keeping for migration
  companyId Int?
  company   Company? @relation("LegacyCompanyUsers", fields: [companyId], references: [id])

  managedCompanies Company[] @relation("CompanyManager")

  roleId Int?
  role   Role? @relation(fields: [roleId], references: [id])

  ownedTasks         Task[] @relation("TaskOwner")
  collaboratingTasks Task[] @relation("TaskCollaborators")

  comments TaskComment[]

  notifications Notification[]

  sentMessages  Message[]
  conversations Conversation[] @relation("UserConversations") // Implicit M:N

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  companies Company[]
}

model Employee {
  id           Int       @id @default(autoincrement())
  matricula    String    @unique
  firstName    String
  lastName     String?
  cpf          String?   @unique
  funcao       String?
  setor        String?
  dataAdmissao DateTime
  dataDemissao DateTime?

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  meals Meal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id          String  @id @default(uuid()) // Using UUID to match frontend expectation of string IDs optionally
  title       String
  description String?
  status      String  @default("todo") // todo, doing, done
  priority    String  @default("medium") // low, medium, high
  isPublic    Boolean @default(false)

  ownerUserId Int
  owner       User @relation("TaskOwner", fields: [ownerUserId], references: [id])

  collaborators User[] @relation("TaskCollaborators")

  comments TaskComment[]

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
}

model TaskComment {
  id      Int    @id @default(autoincrement())
  content String

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId Int
  author   User @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
}

model Notification {
  id          String  @id @default(uuid())
  type        String // chat, task-assigned, task-comment
  title       String
  description String
  entityId    String?

  userId Int
  user   User @relation(fields: [userId], references: [id])

  actorName String?
  read      Boolean @default(false)
  archived  Boolean @default(false)

  createdAt DateTime @default(now())
}

model Conversation {
  id            String    @id @default(uuid())
  createdAt     DateTime  @default(now())
  lastMessageAt DateTime?

  participants User[]    @relation("UserConversations")
  messages     Message[]
}

model Message {
  id      String @id @default(uuid())
  content String

  senderId Int
  sender   User @relation(fields: [senderId], references: [id])

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  deliveredAt DateTime?
  readAt      DateTime?
  status      String? // sent, delivered, read
}

model Meal {
  id          Int       @id @default(autoincrement())
  date        DateTime
  price       Decimal
  periodStart DateTime?
  periodEnd   DateTime?

  employeeId Int?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  // Snapshots for history (redundant but safe for reporting if generic employee changes)
  matriculaSnapshot      String  @default("") // Required in logic, default empty for migration safety if needed
  employeeNameSnapshot   String?
  employeeSectorSnapshot String?
  status                 String  @default("LINKED") // LINKED, PENDING_LINK
  ignoredInExport        Boolean @default(false)

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
}
