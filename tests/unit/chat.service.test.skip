const { mockReset } = require("jest-mock-extended");

// Inline mock to be absolutely sure
jest.mock("../../utils/socket", () => ({
  getIO: jest.fn().mockReturnValue({
    to: jest.fn().mockReturnThis(),
    emit: jest.fn(),
  }),
}));

jest.mock("../../utils/prisma");

const prisma = require("../../utils/prisma");
const service = require("../../services/chat.service");

describe("ChatService", () => {
  beforeEach(() => {
    mockReset(prisma);
  });

  it("getUserConversations should list", async () => {
    const mockConversations = [
      {
        id: 1,
        participants: [{ id: 1 }],
        messages: [{ senderId: 2, status: "sent" }],
      },
    ];
    prisma.conversation.findMany.mockResolvedValue(mockConversations);

    if (!service || !service.getUserConversations) {
      console.error("SERVICE IS:", service);
      // Verify if it's the class or empty
      throw new Error("Service load failed");
    }

    const result = await service.getUserConversations(1);
    expect(result).toHaveLength(1);
  });
});
